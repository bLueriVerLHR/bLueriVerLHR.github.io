# Hummingbird E203

# 基本信息

- 多级流水线，非严谨定义为 **2 级流水线**
    - LSU 为三级流水线
    - 其余为二级流水线
- 单发射
- 模块化，重视可重用性
- 面积最小化，追求低功耗，小面积
    - 复用数据通路
    - 时序，面积冲突中，选择面积优先
- 结构简单
- 性能提倡够用即可
- 支持 **RV32IMAC**

# 微架构

## IFU

- Mini-Decoder 对取回指令进行简单译码
    - 复用 Decoder 并接零，悬空部分端口让综合工具优化。
- Simple-BPU 分析 Mini-Decoder 译码得到的信息，检查是否是分支跳转指令，并进行分支预测。
    - 静态预测
    - 向前跳转预测为不需要跳转
    - 向后跳转预测为需要跳转
    - JALR 处理
        - rs1 == x0 直接使用常数 0
        - rs1 == x1 在分析出没有 x1 相关的 RAW，且 OITF 为空后跳转；特地与 RF 中连线，不占据读端口，为其加速
        - rs1 == xn 在分析 OITF，IR，EXU 无任何指令后直接跳转
- PC 生成
    - 按照 16 位指令和 32 位指令与否增加 PC 值
    - pc_rtvec 作为 rst 之后的复位默认值
    - 流水线冲刷，使用 EXU 的传来的地址
    - 用 S-BPU 预测的地址
- ITCM 作为指令存储
    - 没有使用 I-Cache
    - 假定大多数取指都发生在 ITCM 中
    - 假设对外部内存访问出现的情形很少，故不作优化

ITCM 空间有限，这里假设嵌入式软件程序体积较小，能够加载进 ITCM 中。如果取指地址不在 ITCM 所在区间内，则通过 **BIU** 访问外部存储器。

访问 ITCM 和 BPU 采用了剩余缓存（Leftover Buffer）技术：

- 若访问 ITCM，因为 ITCM 由 SRAM 构成，故利用 SRAM 的 Hold-up 特性，将 ITCM 的输出寄存下来。
    - ITCM 的 SRAM 宽度为 64 位，输出为一个与 64 位地址区间对其的数据，称为一个 Lane
    - 因为 IFU 每次取 32 位，故若在同一个 Lane 中，ITCM 不需要真的被读（关闭 CS 使能）
        - 如果顺序取指中 32 位指令需要跨越 64 位边界，则将 SRAM 当前输出的最高 16 位存入 16 位宽的剩余缓存中，并发起新的 ITCM SRAM 访问操作，然后将新的最低 16 位与剩余缓存中组合成 32 位指令。仅需一个周期 ITCM 访问即可取回 32 位指令，不会造成性能损失。
        - 如果非顺序取指中 32 位指令需要跨越 64 位边界，则需要两次访问周期。没有设计多体化的 ITCM，故在节省小面积下放弃此性能点。

## EXU

主要功能：

- 将 IFU 传递过来的指令进行译码和派遣
- 通过译码信息读取对应索引的 RF 数据
- 维护指令的数据相关性
- 将指令派遣给不同运算单元
    - 每次发射派遣一条指令
- 指令交付
- 将运算结果写回 RF
    - 每次写回一条指令

RF 设计为最多支持两个读端口和一个写端口。

### ALU

主要功能：

- 多周期乘除法器
- 访问地址生成（AGU 由 ALU 担任）
- 基础整数操作
    - 逻辑运算，加减法，位移等
- 分支预测解析
    - 负责 Branch 和 Jump 指令的结果解析和执行
- CSR 读写控制

所有功能共享数据一份实际的运算数据通路，以减小面积。

### OITF

- 深度为 2 的 FIFO
- 判断当前指令是否已经派遣出，是否与尚未写回的长指令有 RAW 和 WAW 相关性
- 只采用阻塞流水线方式，未使用快速旁路的方法

### Commit

利用 RISC-V 特性，极大简化交付阶段，将交付都安排在了执行阶段。

### WB-Arb

划分为单周期指令和长指令两大类；将长指令的交付和写回分开，使得即使执行了多周期指令，仍然不会阻塞流水线。让后续的单周期指令仍然能够顺利地写回和交付。

含有两级写回仲裁模块：

- 最终协会仲裁，仲裁所有的单周期指令的写回和所有长指令的写回，采用优先级仲裁的方式
- 在没有长指令写回的空闲周期，单周期指令可以随便写回
- 对于长指令的写回，由 OITF 和长指令写回仲裁模块协同完成所有的长指令的写回操作

# 参考资料

[1]胡振波, "手把手教你设计 CPU —— RISC-V 处理器篇," Jun. 2018
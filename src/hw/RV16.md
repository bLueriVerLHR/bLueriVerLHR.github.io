# RV16

# 基本信息

- 基于 **16 位** 的数据通路和功能单元
- **32 位 顺序执行** 的 **标量** **RISC-V** 处理器
- **2 级流水线**
- 支持 **64 KiB** 指令存储和 **64 KiB** 数据存储
- 可配置支持 **RV16-32EC**, **RV16-32IC**, **RV16-32IMC**
- 为 RISC-V M 拓展提供一个快速的和一个缓慢的乘法器用以不同场景
- Dhrystone 和 CoreMark 中分别达到传统 32 位处理器 **75%** 和 **71%** 的性能
- Embench 中达到了 Cortex-M0 处理器 **76%** 的性能
- 实验结果显示比传统的 32 位处理器消耗更少的硬件资源和有更低的功耗
- 多周期

# 微架构

流水线分为两个部分

- IFA (Instruction Fetch and Align)
- IDE (Instruction Decode and Execution)

## IFA

- 每周期生成 **1 条** 指令地址
- 使用 **32 位** 的指令通路，每周期获取 **32 位** 长度的指令

以上保证了能够每周期处理 **1 条** 指令

---

对于 C 拓展的 16 位指令，处理如下：

1. 指令在 Instruction Align 中对齐，并识别是否为压缩指令
2. 送往 C2I 单元将压缩的 16 位指令翻译成非压缩 32 位指令

为最小化硬件资源消耗，仅使用 **1 个** **16 位** 寄存器保存可能不会在本周期用到的 **16 位** 指令。依据寄存器是否可用，判断指令来自于寄存器还是指令存储。

% 一定程度上减少了访存的消耗

## IDE

- **16 位** 数据通路
- 每周期只能处理 **16 位** 操作数
- 每个操作分为两个执行周期处理
    - 一个周期处理 **低 16 位**
    - 一个周期处理 **高 16 位**

### Decoder

解码的同时使用 **1 位** 信号 **ex_status** 来指示当前正在处理的是高还是低 16 位。每一次执行的第一个周期会被重置为 0。

内含两个解码器，一个解码同时考虑执行状态，生成需要的操作数；另一个不考虑执行状态，生成控制信号。

### Register File

两种在 **16 位** 内部数据通路上实现 RF 的方式：

1. 使用 32 位寄存器，并通过控制信号选择高和低 16 位
2. 将每个 32 位寄存器分为两个 16 位寄存器，并按地址建立索引（6位）

实验证明，第二种方式消耗更少硬件资源，因为控制逻辑更加简单。

RV32E 的 16 个 32 位 ARF 和 RV32I 的 32 个 32 位 ARF 分别被实现为 32 个和 64 个 16 位 PRF。

因此相较于传统 32 位 RISC-V 处理器，RV16 的寄存器地址不仅包含指令中的寄存器编号，还包含一个由指令类型和执行状态决定的处在 LSB 的 **1 位** 寄存器地址。

---

通常，在每次执行的第一个周期，首先处理低 16 位数据，下一个周期处理高 16 位数据。

特殊的指令，比如右移指令需要先从高 16 位开始处理，然后处理低 16 位。高 16 位信息会被保存在特殊寄存器中，以在下一个周期重复使用。

对于 L/S 指令，则因为仅有 16 位地址的寻址空间，所以需要保持低 16 位。

% 没看到立即数是否被保存在某个寄存器中，应该是从解码器中取高低位，这在解码器最后有说明。

% 观察解码器输入 ex_status 转换只会产生一个与当前周期不同的状态。如果给出 r0 的 32 位空间，存储 imm 下一周期参加的数据部分，6 位存储下一周期使用的 reg_addr 信息。应该节省需要第二次解码产生的一些消耗吧？

### Arithmetic Logic Unit

包含三个部分：

1. 位移器
2. 加法器
3. 逻辑单元

比较单元位于加法器之后，用于依据加法器结果生成指示两操作数之间关系的信号。信号被用于比较指令和分支指令。

---

位移器步骤如下：

- 左移
    1. 加载低 16 位至 op1，并复制到 op3。op1 与 0 合为 32 位数据并左移，生成低 16 位结果
    2. 加载高 16 位到 op1，与 op3 合为 32 位数据并左移，生成高 16 位结果
- 右移
    1. 加载高 16 位至 op1，并复制到 op3。op1 与 MSB 合为 32 位数据并右移，生成高 16 位结果
    2. 加载低 16 位至 op1，与 op3 合为 32 位数据并右移，生成低 16 位结果

---

加法器需要包含进位信号，并且每一个执行周期的第一个周期重置为 0。

### Multiplier and Divider for RV32M

除法器与常规相似，不过操作数需要两个周期加载。

乘法器分为快速乘法器和缓慢乘法器：

- 快速乘法器由 16 位单周期乘法器构成
    - 低 32 位结果需要 3 次乘法操作
    - 高 32 位结果需要 4 次乘法操作
- 缓慢乘法器则依靠多周期中累加操作数实现

### Optimization

除了乘除法，使用 16 位数据通路基本需要花费两个周期才可以处理一个 32 位操作。这对性能有很大影响，故 RV16 对特定的 RV32I 指令使用了一些优化方案。

1. 如果能通过高位比较就能确定大小，则仅比较高位，只执行一个周期。否则执行两个周期，比较低位。比如 BEQ 如果高位不相等，就可以确定两个操作数不相等。SLT 亦相似。
2. LBU 和 LHU 可以隐藏一次写高位的周期，因为一定为 0。而 LB 和 LH 则需要查看符号情况。